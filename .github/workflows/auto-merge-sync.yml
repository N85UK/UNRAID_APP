name: Auto-merge sync PRs

on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled]

permissions:
  checks: read
  pull-requests: write
  contents: write

jobs:
  automerge:
    runs-on: ubuntu-latest
    if: github.actor == 'github-actions[bot]' || github.event.pull_request.user.login == 'N85UK'
    steps:
      - name: Check PR title and author
        id: check
        run: |
          echo "PR title: ${{ github.event.pull_request.title }}"
          if [[ "${{ github.event.pull_request.title }}" != *"chore(sync)"* ]]; then
            echo "Not a sync PR, exiting"
            exit 78
          fi
          echo "OK"

      - name: Wait for status checks to pass
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const sha = pr.head.sha;
            console.log(`Waiting for checks to be successful on ${sha}`);

            async function waitForSuccess() {
              const MAX_RETRIES = 60; // 10 minutes
              for (let i=0; i<MAX_RETRIES; i++) {
                const { data: checkRuns } = await github.rest.checks.listForRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: sha
                });

                // Filter out the current job/workflow
                const relevantChecks = checkRuns.check_runs.filter(run => run.name !== 'automerge');

                if (relevantChecks.length === 0) {
                   console.log("No other checks found yet...");
                   await new Promise(r => setTimeout(r, 10000));
                   continue;
                }

                const pending = relevantChecks.filter(run => run.status !== 'completed');
                const failed = relevantChecks.filter(run => run.status === 'completed' && !['success', 'neutral', 'skipped'].includes(run.conclusion));

                if (failed.length > 0) {
                  console.log(`Checks failed: ${failed.map(r => r.name).join(', ')}`);
                  return false;
                }

                if (pending.length > 0) {
                  console.log(`Waiting for checks: ${pending.map(r => r.name).join(', ')}`);
                } else {
                  console.log("All checks passed!");
                  return true;
                }

                await new Promise(r => setTimeout(r, 10000));
              }
              return false;
            }
            
            const ok = await waitForSuccess();
            if (!ok) throw new Error('Status checks did not finish successful in time');

      - name: Merge PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: 'merge',
              commit_title: 'chore(sync): Auto-merge synced templates'
            });
